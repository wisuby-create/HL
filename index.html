<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Heartline ‚Äî Foundation</title>
<style>
:root{ --pink:#ff6aa2; --pink2:#ff8bb6; --me:#4f46e5; --ink:#0f172a; --muted:#6b7280; }
html,body{height:100%;margin:0;background:#0b0e14}
#root{height:100%;display:grid;place-items:center;padding:12px}
.phone{
  width:min(430px,100%); height:calc(100vh - 24px); position:relative; overflow:hidden;
  background:linear-gradient(180deg,#ffe6ef,#f7f2ff 60%,#f1f5ff);
  border-radius:28px; box-shadow:0 10px 40px rgba(0,0,0,.55);
  font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
}
.status{position:absolute;inset:0 0 auto 0;height:44px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;letter-spacing:.3px}
.status::before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,#0f172a,#111827 70%,#0f172a)}
.status span{position:relative;z-index:1;font-size:14px;opacity:.9}
.screen{position:absolute;inset:44px 0 0 0;overflow:auto}

/* START */
.start{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;padding:18px}
.logo{font-family:Georgia,serif;color:#fff;text-shadow:0 10px 30px rgba(0,0,0,.35);font-size:48px}
.hero{width:92%;aspect-ratio:3/4;border-radius:24px;overflow:hidden;position:relative;box-shadow:0 14px 40px rgba(255,105,180,.28);background:#ffdbe9 center/cover no-repeat}
.hero.has-img{background-image:url('assets/start-cover.jpg')}
.row{display:flex;gap:10px}
.btn{border:0;border-radius:18px;padding:14px 22px;font-weight:900;color:#fff;background:linear-gradient(90deg,var(--pink),var(--pink2));box-shadow:0 8px 24px rgba(255,105,180,.35);cursor:pointer}
.btn.secondary{background:rgba(15,23,42,.8);box-shadow:none}

/* NAME */
.name-wrap{height:100%;display:grid;place-items:center;padding:18px}
.card{width:92%;background:rgba(255,255,255,.78);backdrop-filter:blur(12px);border-radius:20px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
.name-top{display:flex;gap:12px;align-items:center}
.protag{width:72px;height:72px;border-radius:50%;border:3px solid #fff;background:#fbe9ef center/cover no-repeat}
.protag.has-img{background-image:url('assets/protagonist.png')}
.input{display:flex;gap:8px;margin-top:10px}
.input input{flex:1;font-size:16px;padding:12px 14px;border-radius:12px;border:1px solid #e5e7eb}

/* HOME */
.home{height:100%;padding:16px;display:flex;flex-direction:column;gap:16px}
.dock{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.app{background:#fff;border-radius:18px;padding:14px 10px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.08)}
.app .ico{width:52px;height:52px;margin:0 auto 8px;border-radius:12px;display:grid;place-items:center;color:#fff;font-weight:900}
.app span{font-weight:800}
.noti{background:#fff;border-radius:14px;padding:10px 12px;box-shadow:0 6px 14px rgba(0,0,0,.06);display:none}

/* LIST */
.list{height:100%;padding:10px 12px;display:flex;flex-direction:column;gap:12px}
.thread{display:flex;gap:12px;align-items:center;background:#fff;border-radius:18px;padding:12px;box-shadow:0 6px 14px rgba(0,0,0,.06)}
.thread.locked{opacity:.55;pointer-events:none}
.ava{width:46px;height:46px;border-radius:50%;flex:none;background:#eee}
.meta{flex:1}.name{font-weight:900}.sub{font-size:14px;color:#6b7280}

/* CHAT */
.chat{height:100%;display:flex;flex-direction:column}
.chat-head{display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(255,255,255,.7);backdrop-filter:blur(10px)}
.back{border:0;background:#111827;color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
.peer{display:flex;align-items:center;gap:10px;font-weight:900}
.chat-body{flex:1;overflow:auto;padding:12px}
.msg{max-width:85%;background:#fff;padding:12px 14px;border-radius:16px;margin:6px 0;box-shadow:0 4px 10px rgba(0,0,0,.06)}
.me{margin-left:auto;background:linear-gradient(90deg,#675bff,#4f46e5);color:#fff}
.choice-wrap{padding:12px;display:flex;flex-direction:column;gap:10px}
.choice{border:0;border-radius:18px;padding:12px 14px;background:linear-gradient(90deg,var(--pink),var(--pink2));color:#fff;font-weight:900;cursor:pointer}
.endnote{padding:16px;text-align:center;color:#334155;font-weight:800}
.hidden{display:none}
.small{font-size:12px;color:#6b7280}
.toast{position:absolute;left:16px;right:16px;bottom:20px;background:#fff;border-radius:14px;padding:10px 12px;box-shadow:0 10px 20px rgba(0,0,0,.15);display:none}
.toast.show{display:block}
</style>
</head>
<body>
<div id="root">
  <div class="phone">
    <div class="status"><span id="clock">12:00</span></div>

    <!-- START -->
    <section class="screen start" id="scrStart">
      <div class="logo">Heartline</div>
      <div class="hero" id="hero"></div>
      <div class="row">
        <button class="btn" id="btnStart">Start</button>
        <button class="btn secondary" id="btnReset">Reset</button>
      </div>
      <div class="small">Foundation build</div>
    </section>

    <!-- NAME -->
    <section class="screen name-wrap hidden" id="scrName">
      <div class="card">
        <div class="name-top">
          <div class="protag" id="protag"></div>
          <div>
            <h2>Enter your name</h2>
            <div class="small">It will appear in dialogues.</div>
          </div>
        </div>
        <div class="input">
          <input id="nameInput" maxlength="16" placeholder="Your name"/>
          <button class="btn" id="nameOk">OK</button>
        </div>
      </div>
    </section>

    <!-- HOME -->
    <section class="screen home hidden" id="scrHome">
      <div class="dock" id="dock">
        <div class="app" data-open="messages"><div class="ico" style="background:#ff5fa2">üí¨</div><span>Messages</span></div>
        <div class="app"><div class="ico" style="background:#22c55e">üìû</div><span>Phone</span></div>
        <div class="app"><div class="ico" style="background:#60a5fa">üñºÔ∏è</div><span>Gallery</span></div>
        <div class="app"><div class="ico" style="background:#f97316">‚è∞</div><span>Clock</span></div>
        <div class="app"><div class="ico" style="background:#38bdf8">üìù</div><span>Notes</span></div>
        <div class="app" data-open="settings"><div class="ico" style="background:#a78bfa">‚öôÔ∏è</div><span>Settings</span></div>
      </div>
      <div class="noti" id="homeNoti">New message</div>
      <div class="noti" id="chapterNoti">Chapter 2 available</div>
      <div class="toast" id="toast">No story loaded. Add <code>story/ch1.js</code>.</div>
    </section>

    <!-- MESSAGES -->
    <section class="screen list hidden" id="scrList"></section>

    <!-- CHAT -->
    <section class="screen chat hidden" id="scrChat">
      <div class="chat-head">
        <button class="back" id="chatBack">Back</button>
        <div class="peer"><div class="ava" id="chatAva" style="background:#fca5a5"></div><div id="chatName">Chat</div></div>
      </div>
      <div class="chat-body" id="chatBody"></div>
      <div class="choice-wrap hidden" id="choices"></div>
    </section>
  </div>
</div>

<script>
/* ===== CLOCK ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const tick=()=>$('#clock').textContent=new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
tick(); setInterval(tick,30_000);

/* ===== STATE ===== */
const LS='heartline_foundation_state';
const newState=()=>({
  playerName:'',
  chapter:1,
  flags:{},
  unlocked:{},
  queue:[],
  threads:{}, // id: {id,name,color,locked,last,msgs:[]}
});
let ST = JSON.parse(localStorage.getItem(LS)||'null') || newState();
const save=()=>localStorage.setItem(LS, JSON.stringify(ST));

/* ===== CONTACTS (UI definicja) ===== */
const CONTACTS=[
  {id:'maya',name:'Maya',color:'#fca5a5'},
  {id:'riven',name:'Riven',color:'#93c5fd'},
  {id:'noah',name:'Noah',color:'#86efac'},
  {id:'victor',name:'Victor',color:'#c7d2fe'},
];
function ensureThreads(){
  CONTACTS.forEach(c=>{
    ST.threads[c.id] ||= {id:c.id,name:c.name,color:c.color,locked:true,last:'Locked',msgs:[]};
  });
}

/* ===== NAV ===== */
const scrStart=$('#scrStart'), scrName=$('#scrName'), scrHome=$('#scrHome'), scrList=$('#scrList'), scrChat=$('#scrChat');
const show=el=>[scrStart,scrName,scrHome,scrList,scrChat].forEach(s=>s.classList.toggle('hidden',s!==el));

$('#btnStart').onclick=()=>show(ST.playerName?scrHome:scrName);
$('#btnReset').onclick=()=>{ localStorage.removeItem(LS); ST=newState(); ensureThreads(); paintHome(); show(scrStart); };

$('#nameOk').onclick=()=>{
  ST.playerName=($('#nameInput').value.trim()||'You'); save();
  callStory('boot'); // fabu≈Ça mo≈ºe np. odblokowaƒá Mayƒô i wys≈Çaƒá notyfikacjƒô
  paintHome(); show(scrHome);
};

/* ===== HOME ===== */
function paintHome(){
  try{ fetch('assets/start-cover.jpg',{method:'HEAD'}).then(r=>{ if(r.ok) $('#hero').classList.add('has-img'); }); }catch(e){}
  try{ fetch('assets/protagonist.png',{method:'HEAD'}).then(r=>{ if(r.ok) $('#protag').classList.add('has-img'); }); }catch(e){}
  try{ fetch('assets/sakura-closeup.jpg',{method:'HEAD'}).then(r=>{ if(r.ok){ scrHome.style.background=`linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.9)), url('assets/sakura-closeup.jpg') center/cover no-repeat`; } }); }catch(e){}
  $('#homeNoti').style.display = ST.queue.length ? 'block':'none';
  $('#homeNoti').textContent = ST.queue.length ? `New message from ${cap(ST.queue[0].contact)}` : 'No new messages';
  $('#chapterNoti').style.display = ST.chapter>=2 ? 'block':'none';
  if(!window.HeartlineStory){ const t=$('#toast'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); }
}
$('#dock').addEventListener('click',e=>{
  const app=e.target.closest('.app'); if(!app) return;
  const to=app.dataset.open;
  if(to==='messages'){ renderThreads(); show(scrList); }
  if(to==='settings'){ alert('Settings (placeholder) ‚Äî Foundation'); }
});
$('#homeNoti').onclick=()=>{ renderThreads(); show(scrList); };

/* ===== LISTA WƒÑTK√ìW ===== */
function renderThreads(){
  ensureThreads(); save();
  scrList.innerHTML='';
  const top=document.createElement('div'); top.className='chat-head';
  top.innerHTML=`<button class="back" id="toHome">Back</button><b>Messages</b>`;
  scrList.appendChild(top); $('#toHome').onclick=()=>show(scrHome);

  CONTACTS.forEach(c=>{
    const T=ST.threads[c.id];
    const row=document.createElement('div'); row.className='thread'+(T.locked?' locked':''); row.dataset.id=c.id;
    row.innerHTML=`<div class="ava" style="background:${T.color}"></div>
      <div class="meta"><div class="name">${T.name}</div>
      <div class="sub">${T.last || (T.locked?'Locked':'')}</div></div>`;
    row.onclick=()=>openChat(c.id);
    scrList.appendChild(row);
  });

  // wej≈õcie do listy czy≈õci badge/toast
  ST.queue=[]; save(); paintHome();
}

/* ===== CZAT ‚Äî SILNIK ===== */
const CHAT=$('#chatBody'), CHO=$('#choices');
let current=null;

function openChat(id){
  ensureThreads(); current=id;
  const T=ST.threads[id];
  $('#chatName').textContent=T.name;
  $('#chatAva').style.background=T.color;
  CHAT.innerHTML=''; CHO.classList.add('hidden'); show(scrChat);
  $('#chatBack').onclick=()=>{ renderThreads(); show(scrList); };

  // odtw√≥rz historiƒô
  T.msgs.forEach(m=>appendMsg(m.from,m.text,m.me));

  // popro≈õ fabu≈Çƒô o sekwencjƒô do odtworzenia (je≈õli jest)
  if(window.HeartlineStory){
    const seq = callStory('getScript', id) || [];
    if(seq.length) runSequence(seq);
  }else{
    appendMsg('System','No story loaded. Add script in story/ch1.js.');
  }
}

function appendMsg(from,text,me=false){
  const el=document.createElement('div'); el.className='msg'+(me?' me':'');
  el.textContent = (me || from==='You') ? text : `${cap(from)}: ${text}`;
  CHAT.appendChild(el); CHAT.scrollTop=CHAT.scrollHeight;
  if(current){
    const T=ST.threads[current];
    T.msgs.push({from:me?'You':from,text,me});
    T.last=text; save();
  }
}

function showChoices(items){
  CHO.innerHTML=''; items.forEach(ch=>{
    const b=document.createElement('button'); b.className='choice'; b.textContent=ch.text;
    b.onclick=()=>{ CHO.classList.add('hidden'); appendMsg('You', ch.text, true); if(ch.then) runSequence(ch.then); if(ch.sys) handleSystem(ch.sys,ch.payload); };
    CHO.appendChild(b);
  });
  CHO.classList.remove('hidden');
}

function runSequence(seq){
  let i=0;
  const step=()=>{
    if(i>=seq.length) return;
    const node=seq[i++];
    if(node.from){ appendMsg(node.from, interpolate(node.text)); return step(); }
    if(node.choice){ showChoices(node.choice); return; }
    if(node.sys){ handleSystem(node.sys, node.payload); return step(); }
  };
  step();
}

function handleSystem(cmd, payload){
  if(cmd==='unlock'){ const id=payload; if(ST.threads[id]){ ST.threads[id].locked=false; ST.threads[id].last='Tap to open'; save(); } }
  if(cmd==='notify'){ ST.queue.push({contact:payload.contact, preview:payload.preview}); save(); paintHome(); }
  if(cmd==='chapter'){ ST.chapter = payload; save(); paintHome(); }
  callStory('onSystem', cmd, payload); // opcjonalny callback fabu≈Çy
}

function interpolate(t){ return (t||'').replaceAll('{name}', ST.playerName||'You'); }
function cap(s){ return s? s.charAt(0).toUpperCase()+s.slice(1):''; }

/* ===== API dla plik√≥w fabu≈Çy ===== */
const HeartlineAPI = {
  state: ()=>ST,
  save: ()=>save(),
  unlock: (contactId)=>handleSystem('unlock', contactId),
  notify: (contact, preview)=>handleSystem('notify', {contact,preview}),
  chapter: (n)=>handleSystem('chapter', n),
  append: (contact, from, text, me=false)=>{ const keep=current; current=contact; appendMsg(from,text,me); current=keep; },
};
window.HeartlineAPI = HeartlineAPI;
function callStory(fn, ...args){
  if(!window.HeartlineStory) return null;
  const f=window.HeartlineStory[fn];
  if(typeof f==='function') return f(HeartlineAPI, ...args);
  return null;
}

/* ===== BOOT ===== */
(function boot(){
  ensureThreads(); save();
  if(!ST.playerName){ show(scrStart); } else { paintHome(); show(scrHome); }
})();
</script>

<script src="story/ch1.js"></script>

</body>
</html>
